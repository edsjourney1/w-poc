import{getAssetId,getImgFileExtension}from"./tools.js";let appendQueryParams=(e,t)=>{let a=e.searchParams;return t.forEach((e,t)=>{a.set(t,e)}),e.search=a.toString(),e.toString()},createSmartCropPicture=(e,t,a,r,s,i,n="")=>{var o=new URL(e),d=document.createElement("picture"),c=(d.classList.add("eds-asset-image"),o).pathname,c=c.substring(c.lastIndexOf(".")+1),l=document.createElement("img");return l.setAttribute("loading","lazy"),0<n.length?l.setAttribute("alt",n):l.setAttribute("alt",""),l.addEventListener("error",()=>{console.error("Smartcropped image loading error: ",e)}),d.appendChild(l),"landscape"===i?l.setAttribute("src",appendQueryParams(o,new URLSearchParams({smartcrop:"landscape",height:a.height||"400",width:a.width||"400",format:c}))):"square"===i&&l.setAttribute("src",appendQueryParams(o,new URLSearchParams({smartcrop:"square",height:s.height||"400",width:s.width||"400",format:c}))),d},createOptimizedPicture=(r,s="",i=!1,n=[{media:"(max-width:480px)",width:"480"},{media:"(max-width:1023px)",width:"1023"},{media:"(max-width:1200px)",width:"1200"},{media:"(max-width:1920px)",width:"1920"}])=>{let o=new URL(r),d=document.createElement("picture");d.classList.add("eds-asset-image");var e=o.pathname;let c=e.substring(e.lastIndexOf(".")+1);return n.forEach((e,t)=>{var a=new URLSearchParams({width:e.width,format:c});t<n.length-1?(t=document.createElement("source"),e.media&&t.setAttribute("media",e.media),t.setAttribute("srcset",appendQueryParams(o,a)),d.appendChild(t)):((e=document.createElement("img")).setAttribute("loading",i?"eager":"lazy"),0<s.length?e.setAttribute("alt",s):e.setAttribute("alt",""),d.appendChild(e),e.setAttribute("src",appendQueryParams(o,a)),e.addEventListener("error",()=>{console.error("Optimized image loading error: ",r)}))}),d},getImgDetails=async e=>{e=getAssetId(e);if(e)try{var t=await fetch(`https://delivery-p140377-e1434145.adobeaemcloud.com/adobe/assets/${e}/metadata`,{method:"GET",headers:{"If-None-Match":"string"}});return t.ok?await t.json():""}catch(e){}return""},formImageLinks=e=>{e.forEach(e=>{var t,a,r,s,i,n,o=e.getAttribute("href")||"";e.parentNode&&"EM"===e.parentNode.tagName&&(t=e.parentNode.previousElementSibling)&&t.classList.contains("eds-asset-image")&&(a=document.createElement("a"),[r,s]=o.split("#")||[],[s,i,n]=s?.split("--")||[],s&&(a.title=decodeURIComponent(s)),"new"===i?(a.href=r,a.target="_blank"):a.href="jump"===i&&n?"#"+n:o,e.remove(),t.parentNode.insertBefore(a,t),a.append(t))})},renderImages=async(e,t)=>{let a=Array.from(e.querySelectorAll("a"));await Promise.all(a.map(async a=>{let r="landscape";(a.closest(".title-banner-container")||a.closest(".benefit-block-icon-container")||a.closest(".benefit-block-image-container")||a.closest(".bio-grid-wrapper")||a.closest(".blog-hero-article-container")||a.closest(".image-content-container")||a.closest(".image-content-with-icon-container")||a.closest(".image-overlap-container")||a.closest(".siteheader-subnav-info"))&&(r="square");var s=a.getAttribute("href")||"",i=-1<s.indexOf("/adobe/assets/urn:aaid");if(-1<s.indexOf("scene7.com/is/image/")&&"EM"!==a.parentNode.tagName&&((n=document.createElement("img")).src=s,n.classList.add("eds-asset-image"),n.setAttribute("alt",a.innerText||a.textContent),a.replaceWith(n)),i){var n="EM"===a.parentNode.tagName;if(getImgFileExtension(s)&&!n){let e="";i=decodeURIComponent((new URL(s).hash||"#").trim().substring(1)),n=await getImgDetails(a.getAttribute("href"));e=(n?.assetMetadata||{})["dc:title"]||"",i&&(e=i),""===i&&(e="");let t;i=n?.repositoryMetadata?.smartcrops?.square,n=n?.repositoryMetadata?.smartcrops?.landscape;t="square"===r&&i?createSmartCropPicture(s,null,null,null,i,"square",e):"landscape"===r&&n?createSmartCropPicture(s,null,n,null,null,"landscape",e):createOptimizedPicture(s,e),a.replaceWith(t)}}})).then(()=>{formImageLinks(a)}).then(()=>{t&&setTimeout(()=>{t.call()},100)})},decorateExternalImages=async e=>{await renderImages(e)};export default decorateExternalImages;export{renderImages};