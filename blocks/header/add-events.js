import{debounce}from"../../scripts/tools.js";import{closeAllBlogMenuItems}from"./form-blog-menu.js";import loginEventFn from"./login-events.js";import loginURLs from"./login-urls.js";import{navClicks,closeAllNavItems}from"./nav-clicks.js";import popupDataAnalytics from"./popup-analytics.js";let{loginApiUrl,loginFailApiUrl,recaptchaSiteKey,cookieApiUrl,mfaFalse,mfaTrue,mfaNA,profileApiUrl,portals}=JSON.parse(loginURLs),bodyElem=document.querySelector("body"),activeCls="siteheader-active",windowWidth=window.outerWidth,windowHeight=window.outerHeight,formSubmitted=!1,navArr=[],validateField=e=>(0===e.value.trim().length?e.parentNode.querySelector(".siteheader-login-error").classList.add("error-visible"):e.parentNode.querySelector(".siteheader-login-error").classList.remove("error-visible"),0===e.value.trim().length),validateLoginForm=(e,t,a)=>{var r,l=validateField(e),i=validateField(t);return l||i?(a.querySelector("ul")?.remove(),a.querySelector(".siteheader-response-error")?.remove(),a.classList.add("error-visible"),(r=document.createElement("ul")).innerHTML+=l?`<li><label for=${e.getAttribute("id")}>${e.getAttribute("data-errortext")}</label></li>`:"",r.innerHTML+=i?`<li><label for=${t.getAttribute("id")}>${t.getAttribute("data-errortext")}</label></li>`:"",a.append(r)):a.classList.remove("error-visible"),l||i},toggleThisForm=(t,a)=>{Array.from(t.querySelectorAll("input, button")).forEach(e=>{a?(e.setAttribute("disabled","disabled"),t.closest(".siteheader-login-wrapper-grid")?.classList.add("siteheader-login-wrapper-grid-disabled")):(e.removeAttribute("disabled"),e.value="",t.closest(".siteheader-login-wrapper-grid")?.classList.remove("siteheader-login-wrapper-grid-disabled"))})},toggleAllForms=(e,t)=>{toggleThisForm(e.primary,t),toggleThisForm(e.secondary,t)},addValidation=t=>{let a=t.primary.closest(".siteheader-login-wrapper").querySelector(".siteheader-login-error-common"),i=t.primary.querySelector('[name="userid"]'),o=t.primary.querySelector('[name="password"]'),s=(i.addEventListener("keyup",()=>{formSubmitted&&validateLoginForm(i,o,a)}),o.addEventListener("keyup",()=>{formSubmitted&&validateLoginForm(i,o,a)}),e=>{window.localStorage.setItem("landedFromExternal","true"),window.location.href=e});t.primary.addEventListener("submit",e=>{if(formSubmitted=!0,e.preventDefault(),!validateLoginForm(i,o,a)){toggleAllForms(t,!0);let e=window.grecaptcha;e?e.ready(()=>{e.execute(recaptchaSiteKey,{action:"submit"}).then(async e=>{try{var t=await fetch(loginApiUrl,{method:"POST",headers:{"Content-Type":"application/json",recaptchaid:e},credentials:"include",body:JSON.stringify({username:i.value,password:o.value,ipAddress:"192.168.1.1"})});if(t.ok){var a=await fetch(cookieApiUrl,{method:"GET",credentials:"include"});if(a.ok){var r=await a.json();if(r.jwt)if((t.mfa||{}).isMFARequired)t.isMFAEnrolled?window.location.href=mfaTrue:window.location.href=mfaFalse;else{var l=await fetch(profileApiUrl,{method:"GET",credentials:"include",headers:{Authorization:"Bearer "+r.jwt}});if(l.ok){let e=((await l.json())?.data?.orgType||"").toLowerCase();/^ws/.test(e)&&(e=e.substring(2)),portals[e]?window.location.href=portals[e]:window.location.href=mfaNA}else s(loginFailApiUrl)}else s(loginFailApiUrl)}else s(loginFailApiUrl)}else s(loginFailApiUrl)}catch(e){s(loginFailApiUrl)}})}):s(loginFailApiUrl)}})},addLoginEvents=(e,t,a,r,l)=>{var i=t?.querySelector("button"),e=e.querySelector(`.siteheader-${a}-wrapper-outer`);loginEventFn(i,t,e,navArr,r,l,a)},loginCtaWrapEl,logoutCtaWrapEl,loginWrapper,logoutWrapper,addAccountEvents=(e,t,a)=>{loginCtaWrapEl=e?.querySelector(".siteheader-login-wrapper-cta"),logoutCtaWrapEl=e?.querySelector(".siteheader-logout-wrapper-cta");var r=e?.querySelector("form#gn-loginForm"),l=e?.querySelector("form#gn-loginForm-mobile");loginCtaWrapEl&&addLoginEvents(e,loginCtaWrapEl,"login",t,a),logoutCtaWrapEl&&addLoginEvents(e,logoutCtaWrapEl,"logout",t,a),loginWrapper=document.querySelector(".siteheader-login-wrapper"),logoutWrapper=document.querySelector(".siteheader-logout-wrapper"),r&&l&&(addValidation({primary:r,secondary:l}),addValidation({primary:l,secondary:r}))},addEvents=(e,l,t)=>{let a=e?.querySelector(".siteheader-mobile-wrapper > button"),r=document.querySelector(".siteheader-search-wrapper > .siteheader-search-inner"),i=document.querySelector(".siteheader-search-wrapper > button"),o=0,s=0,n=(i.addEventListener("click",()=>{a.classList.contains(activeCls)&&a.dispatchEvent(new MouseEvent("click")),r.classList.contains(activeCls)?(i.classList.remove(activeCls),r.classList.remove(activeCls),t.classList.remove(activeCls),bodyElem.classList.remove("siteheader-search-active"),popupDataAnalytics("close","Search",o)):(o+=1,i.classList.add(activeCls),r.classList.add(activeCls),t.classList.add(activeCls),bodyElem.classList.add("siteheader-search-active"),popupDataAnalytics("open","Search",o))}),e.querySelector(".siteheader-mobile-wrapper > nav"));Array.from(e.querySelectorAll(".siteheader-has-subnav")).forEach((e,t)=>{navArr.push({index:t,isActive:!1,link:e,subnav:e.nextElementSibling})}),navArr.forEach(t=>{t.link.ariaHasPopup="listbox",t.link.addEventListener("click",e=>{e.preventDefault(),navClicks(t,navArr,l)})});let c=Array.from(e.querySelectorAll(".siteheader-mobile-wrapper nav>ul> li > a"));c.forEach(r=>{r.addEventListener("keyup",e=>{if("Tab"===e.key){let t=!1;for(let e=0;e<c.length;e+=1){var a=c[e].parentNode.querySelector(".siteheader-subnav");if(!c[e].isSameNode(r)&&a&&"block"===getComputedStyle(a).display){t=!0;break}}t&&setTimeout(()=>{r.dispatchEvent(new Event("click"))},300),r.parentNode.querySelector(".siteheader-subnav")||closeAllNavItems(navArr,l)}})}),a?.addEventListener("click",()=>{i.classList.contains(activeCls)&&i.dispatchEvent(new MouseEvent("click")),a.classList.contains(activeCls)?(a.classList.remove(activeCls),n.classList.remove(activeCls),bodyElem.classList.remove("siteheader-nav-active"),closeAllNavItems(navArr,l),popupDataAnalytics("close","mobile_navigation",s)):(s+=1,bodyElem.classList.add("siteheader-nav-active"),a.classList.add(activeCls),n.classList.add(activeCls),popupDataAnalytics("open","mobile_navigation",s))});window.addEventListener("scroll",()=>{loginCtaWrapEl?.classList.contains(activeCls)&&loginCtaWrapEl?.querySelector(":scope > button").dispatchEvent(new MouseEvent("click")),logoutCtaWrapEl?.classList.contains(activeCls)&&logoutCtaWrapEl?.querySelector(":scope > button").dispatchEvent(new MouseEvent("click")),document.querySelector(".siteheader-nav-mask."+activeCls)&&closeAllNavItems(navArr,l),document.querySelector(".siteheader-blog-has-subnav-active")&&closeAllBlogMenuItems()}),window.addEventListener("resize",debounce(()=>{var e=window.outerWidth,t=window.outerHeight;windowWidth!==e&&(windowWidth>windowHeight&&e<=t||windowWidth<windowHeight&&t<=e)&&(windowWidth=e,windowHeight=t,closeAllNavItems(navArr,l),closeAllBlogMenuItems())},100)),document.addEventListener("click",t=>{[document.querySelector(".siteheader-mobile-wrapper nav > ul."+activeCls),document.querySelector(".siteheader-login-wrapper."+activeCls),document.querySelector(".siteheader-logout-wrapper."+activeCls),document.querySelector(".siteheader-blog-nav ul.siteheader-blog-has-subnav-active")].forEach(e=>{e&&e!==t.target&&!e.contains(t.target)&&(closeAllNavItems(navArr,l),closeAllBlogMenuItems(),loginWrapper&&loginCtaWrapEl&&loginCtaWrapEl.classList.contains(activeCls)&&loginWrapper.querySelector(".siteheader-login-wrapper-cta > button").dispatchEvent(new MouseEvent("click")),logoutWrapper)&&logoutCtaWrapEl&&logoutCtaWrapEl.classList.contains(activeCls)&&logoutWrapper.querySelector(".siteheader-logout-wrapper-cta > button").dispatchEvent(new MouseEvent("click"))});var e,a=t.target.closest(".siteheader-blog-has-subnav");a&&(e="true"===a.getAttribute("aria-expanded"),a.setAttribute("aria-expanded",e?"false":"true"))}),document.addEventListener("keyup",e=>{"Escape"===e.key&&(closeAllNavItems(navArr,l),closeAllBlogMenuItems(),loginWrapper&&loginCtaWrapEl&&loginCtaWrapEl.classList.contains(activeCls)&&loginWrapper.querySelector(".siteheader-login-wrapper-cta > button").dispatchEvent(new MouseEvent("click")),logoutWrapper)&&logoutCtaWrapEl&&logoutCtaWrapEl.classList.contains(activeCls)&&logoutWrapper.querySelector(".siteheader-logout-wrapper-cta > button").dispatchEvent(new MouseEvent("click")),"Tab"!==e.key||e.target.closest(".siteheader-mobile-wrapper nav")||closeAllNavItems(navArr,l),"Tab"!==e.key||e.target.closest(".siteheader-blog-bottom-wrapper")||closeAllBlogMenuItems()})};export{addEvents,addAccountEvents};