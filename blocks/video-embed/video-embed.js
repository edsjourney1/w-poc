import{trackYTStart,trackYTPause,trackYTResume,trackYTProgress,trackYTComplete}from"../../scripts/analytics.js";import{getDocFileExtension}from"../../scripts/tools.js";let videoCount=0,ytIframeApiReady=!1,videoEmbedCount=Array.from(document.querySelectorAll(".video-embed")).length,prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)"),addYTiframeAPI=()=>{var e=document.createElement("script"),t=(e.src="https://www.youtube.com/iframe_api",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t),window.onYouTubeIframeAPIReady=()=>{ytIframeApiReady=!0}},allYTVideos=[],allCompletedYTVideos=[],intervalId,checkAllVideosCompleted=()=>{let e=!0;(e=allCompletedYTVideos.find(e=>!1===e.isComplete)?!1:e)&&intervalId&&(clearInterval(intervalId),intervalId=null)},calculateYTProgress=()=>{allYTVideos.forEach(t=>{var e;!allCompletedYTVideos.find(e=>e.id===t.id&&e.isComplete)&&t.player&&t.player.getCurrentTime&&(25<=(e=t.player.getCurrentTime()/t.duration*100)&&!t.tracked25&&(t.tracked25=!0,trackYTProgress({video_id:t.id,video_name:t.player.videoTitle,video_url:window.location.href,video_duration:t.duration,video_milestone:25})),75<=e&&!t.tracked75&&(t.tracked75=!0,trackYTProgress({video_id:t.id,video_name:t.player.videoTitle,video_url:window.location.href,video_duration:t.duration,video_milestone:75})),50<=e)&&!t.tracked50&&(t.tracked50=!0,trackYTProgress({video_id:t.id,video_name:t.player.videoTitle,video_url:window.location.href,video_duration:t.duration,video_milestone:50}))}),checkAllVideosCompleted()};function embedYoutube(e,t){var o;e&&ytIframeApiReady&&window.YT&&(o=new window.YT.Player(e.id,{height:"390",width:"640",videoId:e.getAttribute("data-video"),playerVars:{playsinline:1},events:{onReady:e=>window.onYTPlayerReady(e,t),onStateChange:window.onPlayerStateChange,onError:({data:e})=>{console.error("Youtube error code:",e)}}}),allYTVideos.push({id:e.getAttribute("data-video"),player:o,videoTitle:o.videoTitle,tracked25:!1,tracked50:!1,tracked75:!1}),allCompletedYTVideos.push({id:e.getAttribute("data-video"),isComplete:!1}))}function embedVimeo(e,t,o){var[,e]=e.pathname.split("/");let i="";(o||t)&&(i="?"+Object.entries({autoplay:t?"1":"0",background:o?"1":"0"}).map(([e,t])=>e+"="+encodeURIComponent(t)).join("&"));t=document.createElement("div");return t.innerHTML=`<div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;">
      <iframe src="https://player.vimeo.com/video/${e}${i}" 
      style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" 
      frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen  
      title="Content from Vimeo" loading="lazy"></iframe>
    </div>`,t.children.item(0)}function embedDAMVideo(e,t,o){let i="";(o||t)&&(i="?"+Object.entries({autoplay:t?"true":"0",background:o?"1":"0"}).map(([e,t])=>e+"="+encodeURIComponent(t)).join("&"));t=document.createElement("div");return t.innerHTML=`<div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;">
      <iframe src="${e}${i}" 
      style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" 
      frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen  
      title="Content from Vimeo" loading="lazy"></iframe>
    </div>`,t.children.item(0)}function getVideoElement(e,t,o){let i=document.createElement("video");var d=getDocFileExtension(e)||"mp4",o=(i.setAttribute("controls",""),t&&(i.setAttribute("autoplay",""),i.play()),o&&(i.setAttribute("loop",""),i.setAttribute("playsinline",""),i.removeAttribute("controls"),i.addEventListener("canplay",()=>{i.muted=!0,t&&i.play()})),document.createElement("source"));return o.setAttribute("src",e),o.setAttribute("type","video/"+d),i.append(o),i}window.onYTPlayerReady=(e,t)=>{t&&e.target.playVideo(),intervalId=setInterval(calculateYTProgress,100)},window.onPlayerStateChange=e=>{let t=e.target,o="";switch(e.data){case window.YT.PlayerState.PLAYING:.05<=t.getCurrentTime()&&t.getPlayerState()!==window.YT.PlayerState.PAUSED&&(o="resume"),t.getCurrentTime()<.05&&t.getPlayerState()!==window.YT.PlayerState.PAUSED&&(o="start",allYTVideos.forEach(e=>{e.id===t.options?.videoId&&(e.duration=t.getDuration())}),allCompletedYTVideos.forEach(e=>{e.id===t.options?.videoId&&(e.isComplete=!1)}));break;case window.YT.PlayerState.PAUSED:o="pause";break;case window.YT.PlayerState.ENDED:o="complete",allCompletedYTVideos.forEach(e=>{e.id===t.options?.videoId&&(e.isComplete=!0)}),checkAllVideosCompleted()}0<o.length&&t&&t.getCurrentTime&&t.getDuration&&("start"===o&&trackYTStart({video_id:t.options?.videoId,video_name:t.videoTitle,video_url:window.location.href,video_duration:t.getDuration()}),"pause"===o&&trackYTPause({video_id:t.options?.videoId,video_name:t.videoTitle,video_url:window.location.href,video_duration:t.getDuration()}),"resume"===o&&trackYTResume({video_id:t.options?.videoId,video_name:t.videoTitle,video_url:window.location.href,video_duration:t.getDuration()}),"complete"===o)&&trackYTComplete({video_id:t.options?.videoId,video_name:t.videoTitle,video_url:window.location.href,video_duration:t.getDuration(),video_milestone:100})};let loadVideoEmbed=(e,t,o,i)=>{var d,a,r;"true"!==e.dataset.embedLoaded&&(r=new URL(t),d=t.includes("youtube")||t.includes("youtu.be"),a=t.includes("vimeo"),d?embedYoutube(e?.parentNode.querySelector("[data-videotype]"),o):a?(d=embedVimeo(r,o,i),e.append(d),d.querySelector("iframe").addEventListener("load",()=>{e.dataset.embedLoaded=!0})):(getDocFileExtension(t)||-1!==t.indexOf("wellmark.scene7.com")?(a=getVideoElement(t,o,i),e.append(a),console.log("==========link, autoplay, background, videoEl",t,o,i,a),a):(r=embedDAMVideo(t,o,i),e.append(r),r)).addEventListener("canplay",()=>{e.dataset.embedLoaded=!0}))},addYTDivToBlock=(e,t)=>{var o;(t.includes("youtube")||t.includes("youtu.be"))&&(t=(t=new URLSearchParams(new URL(t).search)).get("v")||encodeURIComponent(t.get("v")),(o=document.createElement("div")).id="youtube_player_"+Date.now(),o.setAttribute("data-videotype","yt"),o.setAttribute("data-video",t),e.parentNode.append(o),e.parentNode.classList.add("has-youtube-video"))};export default async function decorate(i){let e=i.querySelector("em a"),d=i.classList.contains("hosted-no-poster"),a=(e=!e&&d?i.querySelector("a"):e).href;addYTDivToBlock(i,a),(videoCount+=1)===videoEmbedCount&&addYTiframeAPI(),setTimeout(()=>{var t=i.querySelector("picture");i.textContent="",i.dataset.embedLoaded=!1;let o=i.classList.contains("autoplay");if(t){i.classList.add("placeholder");let e=document.createElement("div");e.className="video-embed-placeholder",e.append(t),o||(e.insertAdjacentHTML("beforeend",'<div class="video-embed-placeholder-play"><button type="button" title="Play"></button></div>'),e.addEventListener("click",()=>{e.remove(),loadVideoEmbed(i,a,!0,!1)})),i.append(e)}if(!t&&!o&&d){let e=document.createElement("div");e.className="video-embed-placeholder",e.insertAdjacentHTML("beforeend",'<div class="video-embed-placeholder-play"><button type="button" title="Play"></button></div>'),e.addEventListener("click",()=>{e.remove(),i.querySelector("video")?.play()}),i.append(e)}if(!t||o){let t=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(t.disconnect(),e=o&&!prefersReducedMotion.matches,loadVideoEmbed(i,a,e,o))});t.observe(i)}},1500)}