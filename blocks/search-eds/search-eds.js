import{createOptimizedPicture,decorateIcons,fetchPlaceholders}from"../../scripts/aem.js";import{windowUrlDetails}from"../../scripts/tools.js";let searchParams=new URLSearchParams(window.location.search);function findNextHeading(e){let t=e.parentElement.previousElement||e.parentElement.parentElement,r="H2";for(;t;){var a=[...t.querySelectorAll("h1, h2, h3, h4, h5, h6")].pop();t=a?(a=parseInt(a.nodeName[1],10),r=a<6?"H"+(a+1):"H6",!1):t.previousElement||t.parentElement}return r}function highlightTextElements(n,e){e.forEach(e=>{if(e&&e.textContent){let a=[],s=e.textContent;if(n.forEach(e=>{var t;let r=s.toLowerCase().indexOf(e.toLowerCase(),0);for(;0<=r;)a.push({offset:r,term:s.substring(r,r+e.length)}),t=r+e.length,r=s.toLowerCase().indexOf(e.toLowerCase(),t)}),a.length){a.sort((e,t)=>e.offset-t.offset);let n=0;var t=a.reduce((e,{offset:t,term:r})=>{var a;return t<n||((a=s.substring(n,t))&&e.appendChild(document.createTextNode(a)),(a=document.createElement("mark")).textContent=r,e.appendChild(a),n=t+r.length),e},document.createDocumentFragment()),r=s.substring(n);r&&t.appendChild(document.createTextNode(r)),e.innerHTML="",e.appendChild(t)}}})}async function fetchData(e){var t,r=await fetch(e);return r.ok?(t=await r.json())?t.data:(console.error("empty API response",e),null):(console.error("error loading API response",r),null)}function renderResult(e,t,r){var a,n,s=document.createElement("li"),c=document.createElement("a");return c.href=e.path,e.image&&((n=document.createElement("div")).className="search-result-image",a=createOptimizedPicture(e.image,"",!1,[{width:"375"}]),n.append(a),c.append(n)),e.title&&((a=document.createElement(r)).className="search-result-title",(n=document.createElement("a")).href=e.path,n.textContent=e.title,highlightTextElements(t,[n]),a.append(n),c.append(a)),e.description&&((r=document.createElement("p")).textContent=e.description,highlightTextElements(t,[r]),c.append(r)),s.append(c),s}function clearSearchResults(e){e.querySelector(".search-results").innerHTML=""}function clearSearch(e){clearSearchResults(e),window.history.replaceState&&((e=windowUrlDetails).search="",searchParams.delete("q"),window.history.replaceState({},"",e.toString()))}async function renderResults(e,t,r,a){clearSearchResults(e);let n=e.querySelector(".search-results"),s=n.dataset.h;r.length?(n.classList.remove("no-results"),r.forEach(e=>{e=renderResult(e,a,s);n.append(e)})):(e=document.createElement("li"),n.classList.add("no-results"),e.textContent=t.placeholders.searchNoResults||"No results found.",n.append(e))}function compareFound(e,t){return e.minIdx-t.minIdx}function filterData(e,t){let n=[],s=[];return t.forEach(r=>{let a=-1;if(e.forEach(e=>{e=(r.header||r.title).toLowerCase().indexOf(e);e<0||a<e&&(a=e)}),0<=a)n.push({minIdx:a,result:r});else{let t=(r.title+` ${r.description} `+r.path.split("/").pop()).toLowerCase();e.forEach(e=>{e=t.indexOf(e);e<0||a<e&&(a=e)}),0<=a&&s.push({minIdx:a,result:r})}}),[...n.sort(compareFound),...s.sort(compareFound)].map(e=>e.result)}async function handleSearch(e,t,r){var a,e=e.target.value;searchParams.set("q",e),window.history.replaceState&&((a=windowUrlDetails).search=searchParams.toString(),window.history.replaceState({},"",a.toString())),e.length<3?clearSearch(t):await renderResults(t,r,filterData(a=e.toLowerCase().split(/\s+/).filter(e=>!!e),await fetchData(r.source)),a)}function searchResultsContainer(e){var t=document.createElement("ul");return t.className="search-results",t.dataset.h=findNextHeading(e),t}function searchInput(t,r){var e=document.createElement("input"),a=(e.setAttribute("type","search"),e.className="search-input",r.placeholders.searchPlaceholder||"Search...");return e.placeholder=a,e.setAttribute("aria-label",a),e.addEventListener("input",e=>{handleSearch(e,t,r)}),e.addEventListener("keyup",e=>{"Escape"===e.code&&clearSearch(t)}),e}function searchIcon(){var e=document.createElement("span");return e.classList.add("icon","icon-search"),e}function searchBox(e,t){var r=document.createElement("div");return r.classList.add("search-box"),r.append(searchIcon(),searchInput(e,t)),r}export default async function decorate(e){var t=await fetchPlaceholders(),r=e.querySelector("a[href]")?e.querySelector("a[href]").href:"/query-index.json";e.innerHTML="",e.append(searchBox(e,{source:r,placeholders:t}),searchResultsContainer(e)),searchParams.get("q")&&((r=e.querySelector("input")).value=searchParams.get("q"),r.dispatchEvent(new Event("input"))),decorateIcons(e)}export{fetchData};