import sampleData from"./sample-data.js";import{searchFilters,searchQuery,searchURL}from"./search-config.js";import{enableAutocomplete}from"./search-auto-complete.js";let searchParent=document.querySelector(".search-container"),allSearchItems=Array.from(document.querySelectorAll(".search-wrapper")),allSearchBlocks=[],searchWrap,searchGrid,searchLeftCol,searchRightCol,dialogContent,searchHeadTermStr,searchHeadTerm,searchFootTerm,filterLabels,modalLabels,bannerParent,bodyElem=document.querySelector("body"),generateFacetId=(e,t,a,r,n)=>{let l=e.split(" ").join("_").split("-").join("_");return a&&(l+="_"+a.split(" ").join("_").split("-").join("_")),t&&(l+=`_${t}_`+n),r&&(l+=`_${r}_`+n),l},updateModalHeight=()=>{setTimeout(()=>{dialogContent&&bannerParent&&(dialogContent.style.height=window.outerHeight-bannerParent.clientHeight-60-64-42-43+"px")},2e3)},updateTextHeights=()=>{let t,a;Array.from(searchRightCol.querySelectorAll("ul > li")).forEach(e=>{if(t=e.querySelector("p"),a=e.querySelector("input[type=hidden"),t&&a&&(t.innerHTML=a.value,50<t.clientHeight)){for(;50<t.clientHeight;)t.innerHTML=t.innerHTML.substr(0,t.innerHTML.length-1);t.innerHTML=t.innerHTML.substr(0,t.innerHTML.length-5)+"..."}})},updateFacetElements=(a,r,n)=>{let l=document.createElement("ul");var e=(a.facets||[]).find(e=>e.selected);return l.innerHTML=`
    <li><h3>${a.title}</h3></li>
    <li><input id='${generateFacetId(a.key,r+1,null,null,n)}'
      type='checkbox' name='${a.key}' data-value='all' ${e?"":"checked"}>
      <label for='${generateFacetId(a.key,r+1,null,null,n)}'>
        All
        <i class="fa-solid fa-check"></i>
      </label>
    </li>`,(a.facets||[]).forEach((e,t)=>{l.innerHTML+=`<li>
      <input id='${generateFacetId(a.key,r+1,e.value,t+1,n)}'
        type='checkbox' name='${a.key}' data-value='${e.value}' ${e.selected?"checked":""}>
        <label for='${generateFacetId(a.key,r+1,e.value,t+1,n)}'>
          ${e.title}
          <i class="fa-solid fa-check"></i>
        </label>
    </li>`}),l},searchResultAPI=(e,t=1)=>{e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchQuery:searchQuery,variables:{q:e||"test",language:"EN",sort:["BEST_MATCH","DISPLAYDATE_ASC"],offset:10*t,limit:10}})};fetch(searchURL,e).then(e=>{if(e.ok)return e.json();throw new Error("HTTP error! status: "+e.status)}).then(e=>{console.log("=============================GraphQL-Data:",e),buildSearchGrid(e)}).catch(e=>{console.error("Error fetching GraphQL data:",e)})},buildSearchGrid=(searchResultAPI("test",1),h=>{if(searchGrid&&searchLeftCol&&searchRightCol){(searchFilters||[]).forEach((e,t)=>{searchLeftCol.append(updateFacetElements(e,t,0)),dialogContent.append(updateFacetElements(e,t,1))});var{currentPage:e,pageSize:l,totalSize:s}=sampleData;searchHeadTermStr=(searchHeadTermStr=(searchHeadTermStr=(searchHeadTermStr=searchHeadTermStr.replaceAll("{{1}}",(e-1)*l+1)).replaceAll("{{2}}",s<e*l?s:e*l)).replaceAll("{{3}}",s)).replaceAll("{{4}}",`<strong>"${sampleData.q}"</strong>`);let r=document.createElement("div");r.classList.add("cards-div");e=document.createElement("div"),l=(e.classList.add("pagination"),document.createElement("div"));l.classList.add("pagination-container");let n=document.createElement("div"),c=(n.classList.add("count-list"),document.createElement("div")),d=(c.classList.add("count-result"),l.append(n,c),e.append(l),1),o=10;function p(){r.innerHTML="";var e=(d-1)*o,t=e+o,a=(n.innerHTML="",document.createElement("p")),a=(a.textContent="showing",n.appendChild(a),document.createElement("span")),e=(a.textContent=1+e+" - "+Math.min(t,h.data.search.count),n.appendChild(a),document.createElement("p")),t=(e.textContent="of",n.appendChild(e),document.createElement("span"));t.textContent=h.data.search.count,n.appendChild(t)}!function r(){let t=Math.ceil(h.data.search.count/o);function a(e,t){var a=document.createElement("button");return a.textContent=e,a.addEventListener("click",()=>{d=t,p(),searchResultAPI("test",d),r()}),t===d&&a.classList.add("active"),a}function e(){var e=document.createElement("button");return e.textContent="...",e.disabled=!0,e}c.innerHTML="";let n=document.createElement("p"),l=(n.innerHTML='<i class="fa-regular fa-chevrons-left"></i>',n.tabIndex=0,n.role="button",n.ariaLabel="Go to first page",n.addEventListener("click",()=>{d=1,r(),searchResultAPI("test",d),p()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&n.click()}),c.appendChild(n),document.createElement("p"));if(l.innerHTML='<i class="fa-regular fa-chevron-left"></i>',l.tabIndex=0,l.role="button",l.ariaLabel="Go to previous page",l.addEventListener("click",()=>{1<d&&(--d,p(),r(),searchResultAPI("test",d))}),l.addEventListener("keydown",e=>{"Enter"===e.key&&l.click()}),c.appendChild(l),t<=5)for(let e=1;e<=t;e+=1)c.appendChild(a(e,e));else if(d<=3){for(let e=1;e<=3;e+=1)c.appendChild(a(e,e));c.appendChild(e()),c.appendChild(a(t,t))}else if(d>=t-2){c.appendChild(a(1,1)),c.appendChild(e());for(let e=t-2;e<=t;e+=1)c.appendChild(a(e,e))}else{c.appendChild(a(1,1)),c.appendChild(e());for(let e=d-1;e<=d+1;e+=1)c.appendChild(a(e,e));c.appendChild(e()),c.appendChild(a(t,t))}let s=document.createElement("p"),i=(s.innerHTML='<i class="fa-regular fa-chevron-right"></i>',s.tabIndex=0,s.role="button",s.ariaLabel="Go to next page",s.addEventListener("click",()=>{d<t&&(d+=1,p(),r(),searchResultAPI("test",d))}),s.addEventListener("keydown",e=>{"Enter"===e.key&&s.click()}),c.appendChild(s),document.createElement("p"));i.innerHTML='<i class="fa-regular fa-chevrons-right"></i>',i.tabIndex=0,i.role="button",i.ariaLabel="Go to last page",i.addEventListener("click",()=>{d=t,p(),r(),searchResultAPI("test",d)}),i.addEventListener("keydown",e=>{"Enter"===e.key&&i.click()}),c.appendChild(i),p(),searchResultAPI("test",d)}();s=document.createElement("ul");let t="",a="";(h.data.search.items||[]).forEach(e=>{a="",e.isPDF&&(a=`<span class='icon icon-regular--file-pdf'>
          <i class='fa-regular fa-file-pdf' data-icon-name='regular--file-pdf'></i>
        </span>`),t+=`<li>
        <a href='${window.origin}${e.path}'><h3>${e.title} ${a}</h3></a>
        <input type='hidden' value='${e.description}'/>
        <div class='search-results-desc'><p>${e.description}</p></div>
        <cite>${e.url}</cite>
      </li>`}),s.innerHTML=t,searchRightCol.append(searchHeadTerm),searchRightCol.append(s),searchRightCol.append(e),updateModalHeight(),updateTextHeights()}}),buildSearchBanner=e=>{bannerParent=document.querySelector(".search-container");var t,a=document.createElement("div"),r=e.querySelector(":scope > div:nth-child(2)");r&&([r,t]=r.children,a.innerHTML=`<form><div class='search-form-grid'>
      <div class='search-form-col'>
        <div class='search-form-input'>
          <i class='fa-solid fa-magnifying-glass'></i>
          <label for='search_term'>${r.querySelector("p").innerHTML}</label>
          <input id='search_term' placeholder='${r.querySelector("p").innerHTML}' type='search'/>
        </div>
      </div>
      <div class='search-form-col'>
        <button type='submit'><span>${t.querySelector("p").innerHTML}</span><i class='fa-solid fa-magnifying-glass'></i></button>
      </div>
    </div></form>`,e.append(a))},initSearch=()=>{searchWrap=document.createElement("section"),searchGrid=document.createElement("div"),searchLeftCol=document.createElement("div"),searchRightCol=document.createElement("div"),searchWrap.classList.add("search-grid-wrapper"),searchGrid.classList.add("search-grid"),searchLeftCol.classList.add("search-filters"),searchRightCol.classList.add("search-results"),buildSearchBanner(allSearchBlocks[0],searchGrid),searchGrid.append(searchLeftCol),searchGrid.append(searchRightCol),searchWrap.append(searchGrid),searchParent.parentElement.append(searchWrap),[searchHeadTerm,searchFootTerm,filterLabels,modalLabels]=allSearchBlocks[1].children;var e=document.createElement("div"),[t,a]=filterLabels.children;e.innerHTML=`<button type="button"><i class="fa-solid fa-filter"></i><span>${t.textContent}</span></button>`,e.className="search-filters-toggle",searchWrap.insertBefore(e,searchGrid),searchHeadTermStr=searchHeadTerm.querySelector("p")?.innerHTML||"";let r=document.createElement("dialog");r.classList.add("search-filters-dialog"),r.innerHTML=`<div class='search-filters-dialog-header'>
    <h4>${a.textContent}</h4>
    <button type="button" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class='search-filters-dialog-content search-filters'>
  </div>
  <div class='search-filters-dialog-footer'>
    <button type="button">${modalLabels.children[0].textContent}</button>
    <button type="button">${modalLabels.children[1].textContent}</button>
  </div>
  `,bodyElem.append(r),e.addEventListener("click",()=>{bodyElem.classList.add("search-filters-open"),r.showModal()}),r.querySelector(".search-filters-dialog-header button")?.addEventListener("click",()=>{bodyElem.classList.remove("search-filters-open"),r.close()}),dialogContent=r.querySelector(".search-filters-dialog-content")};export default async function decorate(e){e.classList.contains("search-banner")?(e.querySelector(":scope > div:nth-child(2)")?.classList.add("search-hidden"),e.querySelector(":scope > div:last-child")?.classList.add("search-hidden"),e.querySelector(":scope > div:last-child")?.setAttribute("aria-hidden",!0)):(e.classList.add("search-hidden"),e.setAttribute("aria-hidden",!0)),allSearchBlocks.push(e),allSearchItems.length===allSearchBlocks.length&&(initSearch(),enableAutocomplete(searchResultAPI,"test"))}let debounceResize=t=>{let a;return e=>{a&&clearTimeout(a),a=setTimeout(t,100,e)}};window.addEventListener("resize",debounceResize(()=>{updateModalHeight()}));export{searchResultAPI};