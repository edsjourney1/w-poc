let AS_MFE="https://experience.adobe.com/solutions/CQ-assets-selectors/static-assets/resources/assets-selectors.js",IMS_ENV_STAGE="Stage",IMS_ENV_PROD="Production",API_KEY="franklin",REL_DOWNLOAD="http://ns.adobe.com/adobecloud/rel/download",REL_RENDITIONS="http://ns.adobe.com/adobecloud/rel/rendition",IMS_CLIENT_ID="aemcs-wellmark-assetselector",ASSET_SELECTOR_ID="asset-selector",CLIPBOARD_SUPPORTED_BINARY_MIMETYPES=["image/png"],SUPPORTED_RENDITIONS_FORMATS=["image/png","image/jpeg"],imsInstance=null,imsEnvironment=IMS_ENV_PROD;function getRel(e,t){if(e)return e._links[t]}function loadScript(e,t,n){var o=document.querySelector("head"),i=document.createElement("script");return i.src=e,n&&i.setAttribute("type",n),o.append(i),i.onload=t,i}function load(e){e={imsClientId:e["ims-client-id"]||IMS_CLIENT_ID,imsScope:"additional_info.projectedProductContext,openid,read_organizations,AdobeID,ab.manage",redirectUrl:window.location.href,modalMode:!0,imsEnvironment:imsEnvironment,env:imsEnvironment,onAccessTokenReceived:e.onAccessTokenReceived||(()=>{})},e=PureJSSelectors.registerAssetsSelectorsAuthService(e);imsInstance=e}function init(e,t){if(e.environment)if("STAGE"===e.environment.toUpperCase())imsEnvironment=IMS_ENV_STAGE;else{if("PRODUCTION"!==e.environment.toUpperCase())throw new Error("Invalid environment setting!");imsEnvironment=IMS_ENV_PROD}loadScript(AS_MFE,()=>{load(e),t&&t()})}function getCopyRendition(e){let t=null;e=getRel(e,REL_RENDITIONS);return e&&e.forEach(e=>{SUPPORTED_RENDITIONS_FORMATS.includes(e.type)&&(!t||t.width<e.width)&&(t=e)}),t}async function loadImageIntoHtmlElement(o){return new Promise((e,t)=>{let n=new Image;n.setAttribute("crossorigin","anonymous"),n.addEventListener("load",()=>e(n)),n.addEventListener("error",e=>t(e)),n.src=o})}async function convertImage(e,n,o){let i=await loadImageIntoHtmlElement(e);return new Promise(e=>{var t=document.createElement("canvas");t.width=o["tiff:imageWidth"],t.height=o["tiff:imageLength"],t.getContext("2d").drawImage(i,0,0),t.toBlob(e,n)})}async function copyToClipboardWithBinary(e,t,n){var o={};if(CLIPBOARD_SUPPORTED_BINARY_MIMETYPES.includes(t)){var i=await fetch(e);if(!i||!i.ok)throw new Error(`Unexpected status code ${i.status} retrieving asset binary`);i=await i.blob();if(!i)throw new Error("No blob provided in asset response");o[t]=i}else{t="image/png",i=await convertImage(e,t,n);o[t]=i}e=[new ClipboardItem(o)];return navigator.clipboard.write(e)}async function copyAssetWithRapi(e){if(!e)return console.log("Asset metadata does not contain sufficient information"),!1;var t=getCopyRendition(e);if(!t)return console.log("No rendition to copy found"),!1;t=getRel(t,REL_DOWNLOAD);if(!t||!t.href)return console.log("Rendition does not contain sufficient information"),!1;try{var n=t.href,o=await fetch(n,{headers:{Authorization:"Bearer "+imsInstance.getImsToken()}});if(!o.ok)return console.log(`Download request for rendition binary failed with status code ${o.status}: `+o.statusText),!1;var i=await o.json();if(!i)return console.log("Rendition download JSON not provided"),!1;await copyToClipboardWithBinary(i.href,i.type,e)}catch(e){return console.log("Error copying asset using R-API to clipboard",e),!1}return!0}function getAssetSelector(){return document.getElementById(ASSET_SELECTOR_ID)}function handleAssetSelection(e,t){t&&(e.length&&t.onAssetSelected?(1<e.length&&console.log("Multiple items received in selection, but only the first will be used"),t.onAssetSelected(e[0])):!e.length&&t.onAssetDeselected&&t.onAssetDeselected())}async function renderAssetSelectorWithImsFlow(t){var e={handleAssetSelection:e=>handleAssetSelection(e,t),env:t.environment?t.environment.toUpperCase():"PRODUCTION",apiKey:API_KEY,hideTreeNav:!0,runningInUnifiedShell:!1,noWrap:!0,filterSchema:[{header:"File Type",groupKey:"TopGroup",fields:[{element:"checkbox",name:"type",defaultValue:["image/*"],readOnly:!0,options:[{label:"Directories",value:"directory"},{label:"Images",value:"image/*"}]}]},{fields:[{element:"checkbox",name:"type",options:[{label:"JPG",value:"image/jpeg"},{label:"PNG",value:"image/png"},{label:"TIFF",value:"image/tiff"},{label:"GIF",value:"image/gif"},{label:"WEBP",value:"image/webp"}],columns:2}],header:"Mime Types",groupKey:"MimeTypeGroup"}]};t["repository-id"]&&(e.repositoryId=t["repository-id"]),t["ims-org-id"]&&(e.imsOrg=t["ims-org-id"]),t["ims-token"]&&(e.imsToken=t["ims-token"]),PureJSSelectors.renderAssetSelectorWithAuthFlow(getAssetSelector(),e)}async function logoutImsFlow(){return imsInstance.signOut()}export{init,copyAssetWithRapi,renderAssetSelectorWithImsFlow,logoutImsFlow};